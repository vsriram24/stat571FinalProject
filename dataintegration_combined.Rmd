---
title: "dataIntegration_combined"
output: pdf_document
---

```{r}
library(dplyr)
library(ggplot2)
library(glmnet)
library (leaps)
```

# Read in happiness data
```{r}
happiness2019 = read.csv("data/2019.csv")
happiness2019$year = rep(2019, nrow(happiness2019))
happiness2019 = happiness2019 %>%
  mutate(Location = Country.or.region) %>%
  mutate(Happiness.Score = Score) %>%
  mutate(Economy..GDP.per.Capita. = GDP.per.capita) %>%
  mutate(Family = Social.support) %>%
  mutate(Health..Life.Expectancy. = Healthy.life.expectancy) %>%
  mutate(Freedom = Freedom.to.make.life.choices) %>%
  mutate(Trust..Government.Corruption. = Perceptions.of.corruption) %>%
  select(Location, Happiness.Score, Economy..GDP.per.Capita., Family, Health..Life.Expectancy., Freedom, Generosity, Trust..Government.Corruption., year)
```

# Read in world health data
```{r}
# 2015 to 2016
probOfDyingFromDisease = read.csv("data/30-70cancerChdEtc.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%  
  filter(row_number() == 1) %>%
  mutate(probOfDyingFromDisease = First.Tooltip) %>%
  select(Location, probOfDyingFromDisease)

# 2015 to 2018
adolescentBirthRate = read.csv("data/adolescentBirthRate.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(adolescentBirthRate = First.Tooltip) %>%
  select(Location, adolescentBirthRate)

# 2016
airPollutionDeathRate = read.csv("data/airPollutionDeathRate.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(airPollutionDeathRate = gsub( " .*$", "", First.Tooltip )) %>%
  select(Location, airPollutionDeathRate)

# 2015 to 2018
alcoholSubstanceAbuse = read.csv("data/alcoholSubstanceAbuse.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(alcoholSubstanceAbuse = First.Tooltip) %>%
  select(Location, alcoholSubstanceAbuse)

# 2015 to 2017
basicSanitizationServices = read.csv("data/atLeastBasicSanitizationServices.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Total") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(basicSanitizationServices = First.Tooltip) %>%
  select(Location, basicSanitizationServices)

# 2015 to 2017
basicHandwashing = read.csv("data/basicHandWashing.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Total") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  #filter(Period > 2014) %>%
  filter(row_number() == 1) %>%
  mutate(basicHandwashing = First.Tooltip) %>%
  select(Location, basicHandwashing)

# 2015 to 2019
birthsAttendedBySkilledPersonal = read.csv("data/birthAttendedBySkilledPersonal.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  #filter(Period > 2014) %>%
  filter(row_number() == 1) %>%
  mutate(birthsAttendedBySkilledPersonal = First.Tooltip) %>%
  select(Location, birthsAttendedBySkilledPersonal)

# 2015 to 2018
cleanFuelAndTech = read.csv("data/cleanFuelAndTech.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  #filter(Period > 2014) %>%
  filter(row_number() == 1) %>%
  mutate(cleanFuelAndTech = First.Tooltip) %>%
  select(Location, cleanFuelAndTech)

# 2015 to 2016
suicideRates = read.csv("data/crudeSuicideRates.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  #filter(Period > 2014) %>%
  filter(row_number() == 1) %>%
  mutate(suicideRates = First.Tooltip) %>%
  select(Location, suicideRates)

dataAvailabilityForUHC = read.csv("data/dataAvailibilityForUhc.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  #filter(Period > 2014) %>%
  mutate(dataAvailabilityForUHC = First.Tooltip) %>%
  select(Location, dataAvailabilityForUHC)

# 2015 to 2019
dentistsAvailable = read.csv("data/dentists.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  #filter(Period > 2014) %>%
  mutate(dentistsAvailable = First.Tooltip) %>%
  select(Location, dentistsAvailable)

violenceAgainstWomen = read.csv("data/eliminateViolenceAgainstWomen.csv", stringsAsFactors = TRUE) %>%
  filter(Dim2 == "15-49 years") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  #filter(Period > 2014) %>%
  mutate(violenceAgainstWomen = First.Tooltip) %>%
  select(Location, violenceAgainstWomen)

# 2015, 2019
healthyLifeExpectancy = read.csv("data/HALElifeExpectancyAtBirth.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(healthyLifeExpectancy = First.Tooltip) %>%
  select(Location, healthyLifeExpectancy)

# Ignored next dataset because it only had data by region

# 2015
hepBAntigen = read.csv("data/hepatitusBsurfaceAntigen.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(hepBAntigenPrev = gsub( " .*$", "", First.Tooltip )) %>%
  select(Location, hepBAntigenPrev)

# 2015 to 2018
malaria = read.csv("data/incedenceOfMalaria.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(malariaPer1kAtRisk = First.Tooltip) %>%
  select(Location, malariaPer1kAtRisk)
# some countries have 0, may need to exclude

# 2015 to 2019
tuberculosis = read.csv("data/incedenceOfTuberculosis.csv", stringsAsFactors = TRUE) %>%
 group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(tbPer100k = gsub( " .*$", "", First.Tooltip )) %>%
  select(Location, tbPer100k)

# 2015 to 2019
infantMortality = read.csv("data/infantMortalityRate.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(infantMortalityPer1k = gsub( " .*$", "", First.Tooltip )) %>%
  select(Location, infantMortalityPer1k)

# 2015 to 2018
NTDIntervention = read.csv("data/interventionAgianstNTDs.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(NTDIntervention = First.Tooltip) %>%
  select(Location, NTDIntervention)
# Provides # of people not rate so may not be best measure

# 2015, 2019
lifeExpectancy = read.csv("data/lifeExpectancyAtBirth.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(lifeExpectancy = First.Tooltip) %>%
  select(Location, lifeExpectancy)

# 2015 to 2017
maternalMortality = read.csv("data/maternalMortalityRatio.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(maternalMortalityPer100k = gsub( " .*$", "", First.Tooltip )) %>%
  select(Location,  maternalMortalityPer100k)

# 2015 to 2018 (not consistent by country)
doctors = read.csv("data/medicalDoctors.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(DoctorsPer10k = First.Tooltip) %>%
  select(Location, DoctorsPer10k)

# 2015 to 2016
mortalityRatePoisoning = read.csv("data/mortalityRatePoisoning.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(mortalityRatePoisoningPer100k = First.Tooltip) %>%
  select(Location, mortalityRatePoisoningPer100k)

# 2016
mortalityRateUnsafeWash = read.csv("data/mortalityRateUnsafeWash.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(mortalityRateUnsafeWashPer100k = First.Tooltip) %>%
  select(Location, mortalityRateUnsafeWashPer100k)

# 2015 to 2019
neonatalMortality = read.csv("data/neonatalMortalityRate.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(neonatalMortalityPer1k = gsub( " .*$", "", First.Tooltip )) %>%
  select(Location, neonatalMortalityPer1k)

# 2015 and 2019, Data adjusted to remove range, No Data converted to blank and <0.01 converted to 0
NewHivInfectionsPer1000 = read.csv("data/newHivInfectionsNEW.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(NewHivInfectionsPer1000 = First.Tooltip) %>%
  select(Location, NewHivInfectionsPer1000)

# 2015 and 2019, but not all countries have data for each of those years
NursingMidwife = read.csv("data/nursingandmidwife.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(NursingMidwife = First.Tooltip) %>%
  select(Location, NursingMidwife)

# 2015 to 2018 
PharmacistsPer10000 = read.csv("data/pharmacists.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(PharmacistsPer10000 = First.Tooltip) %>%
  select(Location, PharmacistsPer10000)

# 2015+, most countries dont have 2015+ data so may need to relax this condition
PopHealthcareExpGreaterThan10 = read.csv("data/population10SDG3.8.2.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Total") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(PopHealthcareExpGreaterThan10 = First.Tooltip) %>%
  select(Location, PopHealthcareExpGreaterThan10)

# 2015+, most countries dont have 2015+ data so may need to relax this condition
PopHealthcareExpGreaterThan25 = read.csv("data/population25SDG3.8.2.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Total") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(PopHealthcareExpGreaterThan25 = First.Tooltip) %>%
  select(Location, PopHealthcareExpGreaterThan25)

# 2015 to 2019, only latest year for each country included
ModernFamilyPlanningPercent = read.csv("data/reproductiveAgeWomen.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(ModernFamilyPlanningPercent = First.Tooltip) %>%
  select(Location,ModernFamilyPlanningPercent)

# 2016 Only available
RoadTrafficDeathRatePer100000 = read.csv("data/roadTrafficDeaths.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(RoadTrafficDeathRatePer100000 = First.Tooltip) %>%
  select(Location, RoadTrafficDeathRatePer100000)

# 2015+
PopPercentSanitationServices = read.csv("data/safelySanitization.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Total") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(PopPercentSanitationServices = First.Tooltip) %>%
  select(Location, PopPercentSanitationServices)

# 2015+
tobaccoAge15plus = read.csv("data/tobaccoAge15.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(tobaccoAge15plus = First.Tooltip) %>%
  select(Location, tobaccoAge15plus)

# 2015+
uhcIndex = read.csv("data/uhcCoverage.csv", stringsAsFactors = TRUE) %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(uhcIndex = First.Tooltip) %>%
  select(Location, uhcIndex)

# 2015+
under5MortalityRate = read.csv("data/under5MortalityRateADJ.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(under5MortalityRate = First.Tooltip) %>%
  select(Location, under5MortalityRate)

# IT IS BY REGION AND NOT BY COUNTRY
WHOregionLifeExpectancyAtBirth = read.csv("data/WHOregionLifeExpectancyAtBirth.csv", stringsAsFactors = TRUE) %>%
  filter(Dim1 == "Both sexes") %>%
  group_by(Location) %>%
  arrange(desc(Period)) %>%
  filter(row_number() == 1) %>%
  mutate(WHOregionLifeExpectancyAtBirth = First.Tooltip) %>%
  select(Location,  WHOregionLifeExpectancyAtBirth)
```


To-do: include New HIV Infection and Nursing Midwife datasets

# Merge Happiness data with world health data
```{r}
newHappiness = happiness2019 %>%
  left_join(probOfDyingFromDisease, by=c("Location")) %>%
  left_join(adolescentBirthRate, by=c("Location")) %>%
  left_join(alcoholSubstanceAbuse, by=c("Location")) %>%
  left_join(basicHandwashing, by=c("Location")) %>%
  left_join(basicSanitizationServices, by=c("Location")) %>%
  left_join(birthsAttendedBySkilledPersonal, by=c("Location")) %>%
  left_join(cleanFuelAndTech, by=c("Location")) %>%
  left_join(dentistsAvailable, by=c("Location")) %>%
  left_join(suicideRates, by=c("Location")) %>%
  left_join(healthyLifeExpectancy, by=c("Location")) %>%
  left_join(hepBAntigen, by=c("Location")) %>%
  left_join(malaria, by=c("Location")) %>%
  left_join(tuberculosis, by=c("Location")) %>%
  left_join(infantMortality, by=c("Location")) %>%
  left_join(NTDIntervention, by=c("Location")) %>%
  left_join(lifeExpectancy, by=c("Location")) %>%
  left_join(maternalMortality, by=c("Location")) %>%
  left_join(doctors, by=c("Location")) %>%
  left_join(mortalityRatePoisoning, by=c("Location")) %>%
  left_join(mortalityRateUnsafeWash, by=c("Location")) %>%
  left_join(neonatalMortality, by=c("Location")) %>%
  left_join(NewHivInfectionsPer1000, by=c("Location")) %>%
  left_join(NursingMidwife, by=c("Location")) %>%
  left_join(PharmacistsPer10000, by=c("Location")) %>%
  left_join(PopHealthcareExpGreaterThan10, by=c("Location")) %>%
  left_join(PopHealthcareExpGreaterThan25, by=c("Location")) %>%
  left_join(ModernFamilyPlanningPercent, by=c("Location")) %>%
  left_join(RoadTrafficDeathRatePer100000, by=c("Location")) %>%
  left_join(PopPercentSanitationServices, by=c("Location")) %>%
  left_join(tobaccoAge15plus, by=c("Location")) %>%
  left_join(uhcIndex, by=c("Location")) %>%
  left_join(under5MortalityRate, by=c("Location"))

write.csv(newHappiness, "./data/fullHappiness.csv")
```


```{r}
newHappiness = read.csv("./data/fullHappiness.csv")
```

# Drop columns and rows with an inordinate number of missing values
```{r}
colSums(is.na(newHappiness))

newHappiness_filtered = newHappiness %>%
  select(-basicHandwashing, -malariaPer1kAtRisk, -ModernFamilyPlanningPercent,  -PopPercentSanitationServices, -NewHivInfectionsPer1000)

rowSums(is.na(newHappiness_filtered))

newHappiness_filtered = newHappiness_filtered[which(rowMeans(!is.na(newHappiness_filtered)) > 0.5), ]
```

# EDA
```{r}
plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$Economy..GDP.per.Capita., xlab = "Happiness Score", ylab = "GDP per Capita")
text(newHappiness_filtered$Economy..GDP.per.Capita.~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$Family, xlab = "Happiness Score", ylab = "Family")
text(newHappiness_filtered$Family~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$Health..Life.Expectancy., xlab = "Happiness Score", ylab = "Life Expectancy")
text(newHappiness_filtered$Health..Life.Expectancy.~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$Freedom, xlab = "Happiness Score", ylab = "Freedom")
text(newHappiness_filtered$Freedom~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$Generosity, xlab = "Happiness Score", ylab = "Generosity")
text(newHappiness_filtered$Generosity~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$Trust..Government.Corruption., xlab = "Happiness Score", ylab = "Government Corruption Trust")
text(newHappiness_filtered$Trust..Government.Corruption.~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$probOfDyingFromDisease, xlab = "Happiness Score", ylab = "Probability of Dying from Disease")
text(newHappiness_filtered$probOfDyingFromDisease~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$adolescentBirthRate, xlab = "Happiness Score", ylab = "Adolescent Birth Rate")
text(newHappiness_filtered$adolescentBirthRate~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$alcoholSubstanceAbuse, xlab = "Happiness Score", ylab = "Alcohol Substance Abuse")
text(newHappiness_filtered$alcoholSubstanceAbuse~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$basicSanitizationServices, xlab = "Happiness Score", ylab = "Basic Sanitization Services")
text(newHappiness_filtered$basicSanitizationServices~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$birthsAttendedBySkilledPersonal, xlab = "Happiness Score", ylab = "Births Attended by Skilled Personal")
text(newHappiness_filtered$birthsAttendedBySkilledPersonal~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$cleanFuelAndTech, xlab = "Happiness Score", ylab = "Clean Fuel and Tech")
text(newHappiness_filtered$cleanFuelAndTech~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$dentistsAvailable, xlab = "Happiness Score", ylab = "Dentists Available")
text(newHappiness_filtered$dentistsAvailable~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$suicideRates, xlab = "Happiness Score", ylab = "Suicide Rates")
text(newHappiness_filtered$suicideRates~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$healthyLifeExpectancy, xlab = "Happiness Score", ylab = "Healthy Life Expectancy")
text(newHappiness_filtered$healthyLifeExpectancy~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$hepBAntigenPrev, xlab = "Happiness Score", ylab = "Hep B Antigen Prevalence")
text(newHappiness_filtered$hepBAntigenPrev~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$tbPer100k, xlab = "Happiness Score", ylab = "Tuberculosis per 100k")
text(newHappiness_filtered$tbPer100k~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$infantMortalityPer1k, xlab = "Happiness Score", ylab = "Infant Mortality per 1k")
text(newHappiness_filtered$infantMortalityPer1k~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$NTDIntervention, xlab = "Happiness Score", ylab = "NTD Intervention")
text(newHappiness_filtered$NTDIntervention~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$lifeExpectancy, xlab = "Happiness Score", ylab = "Life Expectancy")
text(newHappiness_filtered$lifeExpectancy~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$maternalMortalityPer100k, xlab = "Happiness Score", ylab = "Maternal Mortality per 100k")
text(newHappiness_filtered$maternalMortalityPer100k~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$DoctorsPer10k, xlab = "Happiness Score", ylab = "Doctors Perk 10k")
text(newHappiness_filtered$DoctorsPer10k~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$mortalityRatePoisoningPer100k, xlab = "Happiness Score", ylab = "Mortality Rate Poisoning per 100k")
text(newHappiness_filtered$mortalityRatePoisoningPer100k~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$mortalityRateUnsafeWashPer100k, xlab = "Happiness Score", ylab = "Mortality Rate Unsafe Washing per 100k")
text(newHappiness_filtered$mortalityRateUnsafeWashPer100k~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)

plot(newHappiness_filtered$Happiness.Score, newHappiness_filtered$neonatalMortalityPer1k, xlab = "Happiness Score", ylab = "Neonatal Mortality per 1k")
text(newHappiness_filtered$neonatalMortalityPer1k~newHappiness_filtered$Happiness.Score, labels = newHappiness_filtered$Location)


ggplot(newHappiness_filtered, aes(x=reorder(Location, Happiness.Score), y=Happiness.Score)) + 
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust=0.5),
        axis.text=element_text(size=6))
```

# Impute missing values
```{r}
newHappiness_filtered_imputed = newHappiness_filtered

newHappiness_filtered_imputed$alcoholSubstanceAbuse[is.na(newHappiness_filtered_imputed$alcoholSubstanceAbuse)] <- mean(newHappiness_filtered_imputed$alcoholSubstanceAbuse, na.rm = TRUE)

newHappiness_filtered_imputed$birthsAttendedBySkilledPersonal[is.na(newHappiness_filtered_imputed$birthsAttendedBySkilledPersonal)] <- mean(newHappiness_filtered_imputed$birthsAttendedBySkilledPersonal, na.rm = TRUE)

newHappiness_filtered_imputed$cleanFuelAndTech[is.na(newHappiness_filtered_imputed$cleanFuelAndTech)] <- mean(newHappiness_filtered_imputed$cleanFuelAndTech, na.rm = TRUE)

newHappiness_filtered_imputed$dentistsAvailable[is.na(newHappiness_filtered_imputed$dentistsAvailable)] <- mean(newHappiness_filtered_imputed$dentistsAvailable, na.rm = TRUE)

newHappiness_filtered_imputed$infantMortalityPer1k[is.na(newHappiness_filtered_imputed$infantMortalityPer1k)] <- mean(newHappiness_filtered_imputed$infantMortalityPer1k, na.rm = TRUE)

newHappiness_filtered_imputed$DoctorsPer10k[is.na(newHappiness_filtered_imputed$DoctorsPer10k)] <- mean(newHappiness_filtered_imputed$DoctorsPer10k, na.rm = TRUE)

newHappiness_filtered_imputed = newHappiness_filtered_imputed %>%
  select(-X, -year)
```


# Perform PCA
```{r}
x_newHappiness = newHappiness_filtered_imputed %>%
  select(-Location, -Happiness.Score)
x_newHappiness = sapply(x_newHappiness, as.numeric)

y_newHappiness = newHappiness_filtered_imputed$Happiness.Score
```

```{r}
newHappiness.centered.scaled <- as.data.frame(scale(x_newHappiness, center = T, scale = T))
```

```{r}
newHappiness.centered.pca = prcomp(newHappiness.centered.scaled)
newHappiness.centered.pca.loading <- newHappiness.centered.pca$rotation
```

```{r}
cor(newHappiness.centered.pca.loading[,1],newHappiness.centered.pca.loading[,2])
```

```{r}
summary(newHappiness.centered.pca)$importance

plot(summary(newHappiness.centered.pca)$importance[2, ], ylab="Proportion of Variance", xlab="PC",
main="Proportion of Variance")

plot(summary(newHappiness.centered.pca)$importance[3, ], ylab="Cumulative PVE", xlab="Number of PC's",
main="Cumulative PVE")
```
```{r}
biplot(newHappiness.centered.pca, main="Biplot of the PC's")
abline(v=0, h=0)
# x-axis: PC1 
# y-axis: PC2
# top x-axis: prop to loadings for PC1
# right y-axis: prop to loadings for PC2
```
```{r}
set.seed(123)
fviz_nbclust(as.data.frame(x_newHappiness), kmeans, method = "wss")
```
```{r}
set.seed(123)
newHappiness.kmeans <- as.data.frame(x_newHappiness) %>% kmeans(centers = 3, nstart = 1)

x_newHappiness <- as.data.frame(x_newHappiness) %>% 
  mutate(group = newHappiness.kmeans$cluster) %>% 
  mutate(name = newHappiness_filtered_imputed$Location) %>%
  arrange(group)

data.frame(pc1 = newHappiness.centered.pca$x[, 1],
           pc2 = newHappiness.centered.pca$x[, 2],
           group = as.factor(newHappiness.kmeans$cluster),
           name = as.factor(newHappiness_filtered_imputed$Location)) %>%
  ggplot(aes(x = pc1, y = pc2, col = group, label = name)) + geom_point() + geom_text(aes(label=name)) + ggtitle("Clustering over PC1 and PC2")
```

# Regression
```{r clean data for regression}
colSums(is.na(newHappiness_filtered))
newHappiness_lasso <- newHappiness_filtered %>%
  select(-Economy..GDP.per.Capita., - Family, - Health..Life.Expectancy., -Freedom, -Generosity, -Trust..Government.Corruption., -year)
```

```{r Lasso}
data.happiness <- as.data.frame(na.omit(newHappiness_lasso))
Y <- data.happiness[, 3]
X.hap <- model.matrix(Happiness.Score~.-X-Location, data=data.happiness)[, -1]
fit.hap <- cv.glmnet(X.hap, Y, alpha=1, nfolds=10)
plot(fit.hap$lambda)
coef.1se <- coef(fit.hap, s="lambda.1se")
var.1se <- coef.1se@Dimnames[[1]][coef.1se@i + 1][-1]
lm.input <- as.formula(paste("Happiness.Score", "~", paste(var.1se, collapse = "+")))
fit.1se.lm <- lm(lm.input, data=data.happiness)
summary(fit.1se.lm)

#add correlation matrix?
```

```{r cp tuning}
data.happiness.sub <-  data.happiness[,c("Happiness.Score", var.1se)]

fit.exh <- regsubsets(Happiness.Score ~., data.happiness.sub , nvmax=15, method="exhaustive")
fit.cp <- summary(fit.exh)
opt.size <- which.min(summary(fit.exh)$cp)
cp.var.1 <- fit.cp$which
cp.var <- colnames(cp.var.1)[cp.var.1[opt.size, ]][-1]
cp.fit <- lm(Happiness.Score~., data.happiness[, c("Happiness.Score", cp.var)])
summary(cp.fit)
```

All variables are significant at the .05 level, so we don't need to eliminat further variables with backwards selection.


```


